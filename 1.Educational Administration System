# _*_ Coding: utf-8 _*_
# @Time     :2018/3/11 19:56
# @Author   :Shawn
# @Project  :Web_crawlers
# @Software :PyCharm

import requests
import time
from PIL import Image
import os
from lxml import etree


class Student:
    def __init__(self, usercode, password):
        self.usercode = usercode
        self.password = password
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/53'
                          '7.36 (KHTML, like Gecko) Chrome/64.0.3282.168 Safari/537.36'
        }

    def login(self):
        # Initialization
        url = 'http://jwts.hitsz.edu.cn/login'
        self.headers['Referer'] = 'http://jwts.hitsz.edu.cn/'
        data = {
            'usercode': self.usercode,
            'password': self.password,
            'code': ''
        }

        # get cookies
        session.get(self.headers['Referer'], headers=self.headers)
        # get captcha
        random = str(int(time.time() * 1000) % 10000)
        code = session.get('http://jwts.hitsz.edu.cn/captchaImage?id=' + random, headers=self.headers)
        with open('D:\captcha.jpg', 'wb') as f:
            f.write(code.content)
            f.close()
        im = Image.open('D:\captcha.jpg')
        im.show()
        im.close()
        data['code'] = input('Input captcha:')

        os.system('taskkill /IM Microsoft.Photos.exe /F')
        s = session.post(url, data=data, headers=self.headers)
        if '切换角色' in s.text:
            print('Login successfully. :)')
            return
        else:
            print('Failed to login!!!')
            stu.login()

    def getSchedule(self):
        wday = time.localtime().tm_wday
        url_smst = 'http://jwts.hitsz.edu.cn/kbcx/queryGrkb'
        url_week = 'http://jwts.hitsz.edu.cn/kbcx/queryXszkb'
        self.headers['Referer'] = url_smst
        data = {'xnxq': ''}

        smst_html = session.get(url_smst)
        smst = etree.HTML(smst_html.text)
        xnxq = smst.xpath('//select/option[position()= 1]/@value')
        data['xnxq'] = xnxq

        week_html = session.post(url_week, headers=self.headers, data=data)
        week = etree.HTML(week_html.text)
        sequence = week.xpath('//div[@class="kbtext"]//text()')
        print('Here`s your schedule:')
        for i in range(5):
            n = wday + 7 * i
            if sequence[n] == '&nbsp':
                print('_')
            else:
                print(sequence[n])


if __name__ == '__main__':
    session = requests.session()
    stu = Student('SZ160310221', '19980218')
    stu.login()
    stu.getSchedule()
